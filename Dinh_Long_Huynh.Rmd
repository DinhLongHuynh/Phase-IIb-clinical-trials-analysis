---
title: "EXAMINATION PROJECT"
author: "Dinh_Long Huynh"
date: "Nov 22, 2023"
email: "Dinh-Long.Huynh.4289@student.uu.se"
output: 
  html_document:
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smoot = tidyh_scroll: yes
  word_document:
    toc: yes
    toc_depth: '3'
  pdf_document:
    toc: yes
    toc_depth: '3'
mainfont: null
sansfont: null
mathfont: null
monofont: null
fontsize: null
---

# TASK 1: IMPORT DATA FILES

## Load library

```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(GGally)
library(knitr)
library(PKNCA)
```

## Import data and constant

```{r}
dir_name <- paste0(getwd(), "/Original_data/") #set the flexible directory link
data_pk <- read.csv(paste0(dir_name, "BPI889_PK_29.csv"), header = T, na = ".", dec =".")
kable(head(data_pk, 10), align = "c", caption = "data_pk")
data_snp <- read.table(paste0(dir_name, "BPI889_SNP_29.txt"), header = T, na =".", dec =".", row.names = NULL)
#the row.names = NULL argument is used for indicating that the 1st columns is belong to dataframe, not the row names column.
kable(head(data_snp, 10), align = "c", caption = "Part of data_snp")
dose <- 200
```

# TASK 2: CHANGE VARIABLES NAMES, DATA FORMAT, AND DATA TYPES

```{r}
colnames(data_pk)[1] <- "ID"
data_pk$Sex <- factor(data_pk$Sex, levels = c("M", "F"), labels = c("Male", "Female"))

#Because the data_pk is recently the wide format, so it better to change into long format before merge.
tidy_pk <- gather(data_pk, key = "Time", value = "Concentration", -c("ID","Sex", "Weight..kg.", "Height..cm.", "Age..yrs."))
tidy_pk$Time <- gsub("Time.", "", tidy_pk$Time)
tidy_pk$Time <- gsub(".h", "", tidy_pk$Time)
tidy_pk$Time <- as.numeric(tidy_pk$Time)
kable(head(tidy_pk, 10), align = "c", caption = "Part of tidy_pk: the long format of data_pk")

#Because the data_snp is recently the wide format, so it better to change into long format before merge.
colnames(data_snp)[1] <- "ID"
tidy_snp <- gather(data_snp, key = "SNP", value = "Type", -ID)
tidy_snp$Type <- factor(tidy_snp$Type, levels = c(0, 1, 2), labels = c("Wildtype", "Heterogeneous", "Homogenous"))
kable(head(tidy_snp, n = 10), align = "c", caption = "Part of tidy_snp: the long format of data_snp")
```

# TASK 3: COMBINE PK AND SNP

```{r}
data_all <- merge(tidy_pk, tidy_snp, by = "ID")

#Reorder the columns
data_all <- select(data_all, ID, Sex, Weight..kg., Height..cm., Age..yrs.,SNP, Type, Time, Concentration) 

#Reorder the rows
data_all$ID <- as.numeric(gsub("pat", "", data_all$ID))
data_all <- arrange(data_all, ID,Time)
data_all$ID <- factor(data_all$ID, levels = c(1:100))

#The samples data frame: 
kable(head(data_all, 10), align = "c", caption = "data_all")
```

# TASK 4: CALCULATE BODY COMPOSITION MEASEURMENT: TBW

```{r}
data_all$TBW <- NA
data_all$TBW[data_all$Sex == "Male"] <- round(2.447-0.09156*data_all$Age..yrs. + 0.1074*data_all$Height..cm. + 0.3362*data_all$Weight..kg., 1)
data_all$TBW[data_all$Sex == "Female"] <- round(-2.097 + 0.1067*data_all$Height..cm. + 0.2466*data_all$Weight..kg.,1)
```

# TASK 5: CATEGORIZE TBW INTO TWO GROUPS

```{r}
data_all$CTBW <- NA
data_all$CTBW[data_all$TBW > 40] <- "above 40L"
data_all$CTBW[data_all$TBW < 40] <- "below 40L"

#The samples data frame: 
kable(head(data_all, 10), align = "c", caption = "Part of data_all after adding TBW and CTBW")
```

# TASK 6: CALCULATE CMAX, T1/2, AND CL

## Method 1: Linear regression in the linear range of time

### Find k and Cmax

```{r}
#Change format of ID column in tidy_pk into the same format with data_all
tidy_pk$ID <- as.numeric(gsub("pat", "", tidy_pk$ID))
tidy_pk <- arrange(tidy_pk, ID,Time)
tidy_pk$ID <- factor(tidy_pk$ID, levels = c(1:100))

#Avoid NA value from the starting time point when run PKNCA package.
tidy_pk$Concentration[tidy_pk$Time == 0.15] <- 0

#Determine ln(C) values
tidy_pk$log_con <- log(tidy_pk$Concentration)

#The pharmacokinetic parameters are specified for each ID, thus, the group_by function is used.
#Filter function is used for chosing the time after tmax (approximately 1 hour) and avoid -Inf values
grouped_by_ID <- tidy_pk%>% filter(Time>1 & Time <12 )%>% 
  group_by(ID) %>%
  summarise(k = round(lm(log_con ~ Time)$coefficients[2],3), #linear regression and extract the slope (k)
            Co = round(exp(lm(log_con ~ Time)$coefficients[1]),3)) #linear regression and extract the intercept, which is ln(Co), and then use exp(ln(Co)) to calculate Co
            
#Cmax determination
grouped_by_ID_Cmax <- tidy_pk%>%group_by(ID)%>%summarise(Cmax = max(Concentration, na.rm = T))
#At this point, I have two differents data frame of several grouped parameters, then it should be merge together
grouped_by_ID <- merge(grouped_by_ID,grouped_by_ID_Cmax, by = "ID")
grouped_by_ID <- arrange(grouped_by_ID, ID)
```

### Find t1/2 and CL

```{r}
grouped_by_ID$half.life <- round(log(2)/abs(grouped_by_ID$k),3)
grouped_by_ID$Vd <- round(dose/grouped_by_ID$Co, 3)
grouped_by_ID$CL <- round(abs(grouped_by_ID$k)*grouped_by_ID$Vd,3)

#The samples data frame: 
kable(head(grouped_by_ID, 10), align = "c", caption = "Part of grouped_by_ID after calculating pharmacokinetic parameters")
```

## Method 2: Use PKNCA package
```{r}
#Create the Dose column in tidy pk and extract the dose data frame corresponding to the starting time.
tidy_pk$Dose = 200
dose_data = tidy_pk %>% select(ID, Time, Dose) %>% filter(Time == 0.15)

#To run PKNCA calculator, it is neccessary to create PKNCA_dose and PKNCA_concentration data frame first.
PKNCA_dose = PKNCAdose(dose_data, Dose~Time | ID)
PKNCA_concentration = PKNCAconc(tidy_pk, Concentration~Time|ID)

#Compete data preparation
PKNCA_data = PKNCAdata(PKNCA_concentration,PKNCA_dose)

#Load calculation
PKNCA_results = pk.nca(PKNCA_data)

#Results visualization
Raw_PK_variables = PKNCA_results$result
PK_variables = Raw_PK_variables %>% group_by(ID) %>% summarise(k = -log(2)/PPORRES[PPTESTCD == "half.life"],
                                                               Cmax = PPORRES[PPTESTCD == "cmax"],
                                                               half.life = PPORRES[PPTESTCD == "half.life"],
                                                               CL = dose/PPORRES[PPTESTCD == "auclast"])
#The samples data frame: 
kable(head(PK_variables, 10), align = "c", caption = "Part of PK_variables")
```

# TASK 7: SUMMARIZE CMAX, T1/2, AND CL
## Summary from linear regression method
```{r}
#Loop over parameter to summarise statistical values. Put it in vector to create data frame later.
for (parameter in c("half.life", "Cmax", "CL")) {
  assign(paste0(parameter, "_summary"), c(mean(grouped_by_ID[[parameter]]), 
                                          sd(grouped_by_ID[[parameter]]),
                                          median(grouped_by_ID[[parameter]]),
                                          range(grouped_by_ID[[parameter]])))
}

#Create and print summary data frame
summary_parameter_lm <- data.frame(Half_life = half.life_summary, Cmax = Cmax_summary, CL = CL_summary,
                               row.names = c("Mean", "Standard deviation", "Median", "Min", "Max"))
kable(summary_parameter_lm, align = "c", caption = "Summary of half life, Cmax, and CL")

```
## Summary from PKNCA packages method
```{r}
#Loop over parameter to summarise statistical values. Put it in vector to create data frame later.
for (parameter in c("half.life", "Cmax", "CL")) {
  assign(paste0(parameter, "_summary"), c(mean(PK_variables[[parameter]]), 
                                          sd(PK_variables[[parameter]]),
                                          median(PK_variables[[parameter]]),
                                          range(PK_variables[[parameter]])))
}

#Create and print summary data frame
summary_parameter_PKNCA <- data.frame(Half_life = half.life_summary, Cmax = Cmax_summary, CL = CL_summary,
                               row.names = c("Mean", "Standard deviation", "Median", "Min", "Max"))
kable(summary_parameter_PKNCA, align = "c", caption = "Summary of half life, Cmax, and CL")

```
I have performed a t-test between the values of each variable of the two method. It resulted in no significant difference between two methods.


# TASK 8: GRAPHICALLY DISPLAY INDIVIDUAL CONCENTRATIONS OF BPI889 VERSUS TIME (SPAGHETTI PLOT)

```{r}
ggplot(tidy_pk, aes(x=Time, y=Concentration, group = ID, color = ID))+
  geom_line(na.rm=T)+
  xlab("Time (hours)")+
  ylab("Concentration (mg/L)")+
  ggtitle("Concentration versus Time for each ID")+
  theme_classic()

ggplot(tidy_pk, aes(x=Time, y=log_con, group = ID, color = ID))+
  geom_line(na.rm=T)+
  xlab("Time (hours)")+
  ylab("ln(Concentration)")+
  ggtitle("ln(Concentration) versus Time for each ID")+
  theme_classic()
```

# TASK 9: GRAPHICALLY DISPLAY CORRELATIONS BETWEEN CMAX, T1/2 AND CL (SCATTER PLOT)

## Basic way

```{r}
data_all <- merge(data_all, PK_variables, by = "ID")
pairs(data_all[,c("Cmax", "half.life", "CL")], upper.panel = NULL, lower.panel = panel.smooth)
```

## Ggplot way

```{r}
ggpairs(data_all[,c("Cmax", "half.life", "CL")])
```

# TASK 10: GRAPHICALLY DISPLAY T1/2 AND CL VERSUS SNPS (BOX-WHISKERS PLOTS)

## Basic way

```{r}
par(mfcol=c(2,3))
color <- c("pink", "green", "green4", "lightblue", "purple")
for (type in unique(levels(data_all$Type))) {
  boxplot(half.life~SNP, data_all[data_all$Type == type, ],
          ylab = "Half life (hours)",
          xlab = "Mutations", 
          notch = T,
          col = color,
          main = type)
}

for (type in unique(levels(data_all$Type))) {
  boxplot(CL~SNP, data_all[data_all$Type == type, ],
          ylab = "Clearance (L/h)",
          xlab = "Mutations", 
          notch = T, 
          col = color,
          main = type)
}

```

## Ggplot way

```{r}
half_life_boxplot <- ggplot(data_all, aes(x = SNP, y = half.life, fill = SNP))+
  geom_boxplot(notch = T)+
  theme_classic()+
  ylab("Half life (hours)")+
  xlab("Mutations")+
  facet_grid(~Type)

clearance_boxplot <- ggplot(data_all, aes(x = SNP, y = CL, fill = SNP))+
  geom_boxplot(notch = T)+
  theme_classic()+
  ylab("Clearance (L/h)")+
  xlab("Mutations")+ 
  facet_grid(~Type)

ggarrange(half_life_boxplot, clearance_boxplot, nrow = 2, ncol =1)
```

# TASK 11: GRAPHICALLY DISPLAY CORRELATIONS BETWEEN T1/2 AND TBW TO ASSESS A RELATIONSHIP AND ADD A LINEAR REGRESSION (SCATTER WITH LINEAR REGRESSION)

## Basic way

```{r}
plot(x = data_all$TBW, y = data_all$half.life,
     xlab = "Total body water (L)",
     ylab = "Half life (hours)",
     main = "Correlation between TBW and Half life",
     pch = 16)

TBW_halflife_regression = lm(half.life~TBW, data_all)
abline(coef(TBW_halflife_regression), lwd = 2, col = "blue")
```

## Ggplot way

```{r}
ggplot(data_all, aes(x=TBW, y = half.life))+ 
  geom_point()+
  geom_smooth(method = "lm", na.rm = T)+
  xlab("Total body water (L)")+
  ylab("Half life (hours)")+
  theme_classic()+
  ggtitle("Correlation between TBW and Half life")
```

# TASK 12: PERFORM AN ANOVA OF CL AND CMAX FOR THE FIVE SNPS

## ANOVA for CL between SNPs

```{r}
CL_SNP_aov <- aov(CL~SNP, data_all)
summary(CL_SNP_aov)
```

p-value = 1. Conclusion: There is not enough evidence to reject the "no significant difference" in clearance between SNPs.

## ANOVA for Cmax between SNPs

```{r}
Cmax_SNP_aov <- aov(Cmax~SNP, data_all)
summary(Cmax_SNP_aov)
```

p-value = 1. Conclusion: There is not enough evidence to reject the "no significant difference" in clearance between SNPs.

# TASK 13: PERFORM A T-TEST OF T1/2 FOR THE TWO CATEGORICAL GROUPS OF TBW

```{r}
t.test(half.life~CTBW, data_all)
```

p-value \<\< 0.05 Conclusion: There is a significant difference in drug half life between the groups having TBW above 40L and the groups having TBW below 40L.
